<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soutex - Grid 16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Ajuste para garantir que os cards caibam 4 por linha em telas pequenas */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px;
        }
        .filter-scroll { overflow-x: auto; white-space: nowrap; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(6px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-black text-slate-100 font-sans hide-scroll">

    <div id="ajuste-modal" class="modal p-4">
        <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl w-full max-w-xs shadow-2xl">
            <h3 id="modal-titulo" class="text-center font-black text-blue-500 uppercase mb-4 text-xs tracking-widest">Tecido</h3>
            
            <div class="flex items-center justify-between gap-3 mb-6">
                <button onclick="mudarValor(-15)" class="bg-red-600 active:bg-red-700 w-12 h-12 rounded-full font-black text-lg shadow-lg">-15</button>
                <div class="text-center">
                    <div id="modal-peso" class="text-3xl font-black text-white">0.0</div>
                    <div class="text-[9px] text-slate-500 uppercase font-bold">Quilos (Kg)</div>
                </div>
                <button onclick="mudarValor(15)" class="bg-green-600 active:bg-green-700 w-12 h-12 rounded-full font-black text-lg shadow-lg">+15</button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="fecharModal()" class="bg-slate-800 p-3 rounded-xl font-bold text-[9px] uppercase">Sair</button>
                <button onclick="salvarAjuste()" class="bg-blue-600 p-3 rounded-xl font-black text-[9px] uppercase shadow-blue-900/40 shadow-md">Salvar</button>
            </div>
        </div>
    </div>

    <header class="p-3 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-[11px] font-black text-blue-500 italic">SOUTEX_16GRID</h1>
            <div class="flex gap-1">
                <button onclick="limparTudo()" class="text-[8px] border border-red-500/30 text-red-500 px-2 py-1 rounded">ZERAR</button>
                <label class="bg-blue-600 text-[8px] px-3 py-1.5 rounded font-black cursor-pointer">
                    EXCEL <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
        </div>
        <div id="dynamic-filters" class="flex gap-2 overflow-x-auto pb-1 hide-scroll"></div>
    </header>

    <main class="p-2" id="app-content"></main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc,
  updateDoc, onSnapshot, query, deleteDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBJgHz4GGt1kPq3md5wcVdtYUlqij1i4PE",
  authDomain: "soutex-e9d93.firebaseapp.com",
  projectId: "soutex-e9d93",
  storageBucket: "soutex-e9d93.firebasestorage.app",
  messagingSenderId: "755619229918",
  appId: "1:755619229918:web:a686d19782dc759946124f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const tecidosCol = collection(db, "tecidos");

/* ================= CONFIG ================= */
const SENHA_MESTRA = "1234";
const KG_POR_ROLO = 15;

let tecidos = [];
let filtroAtual = "todos";
let itemSelecionado = null;

/* ================= UTIL ================= */
function normalizarTexto(txt) {
  return String(txt)
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "_")
    .toUpperCase()
    .trim();
}

/* ================= IMAGENS ================= */
function getImagemPrincipal(sub, cor) {
  return `imagens/tecidos/${normalizarTexto(sub)}_${normalizarTexto(cor)}.jpg`;
}
function getImagemSecundaria(sub, cor) {
  return `imagens/tecidos/${normalizarTexto(sub)}_${normalizarTexto(cor)}_2.jpg`;
}

/* ================= MAPA DE PRODUTOS ================= */
const MAPA_PRODUTOS = {
  "1510021015": { tecido: "QUADRILE", categoria: "CAMISARIA" },
  "151501021":  { tecido: "INTRA", categoria: "CAMISARIA" },
  "151501047":  { tecido: "BERLIM", categoria: "BLACKOUT" },

  "1515010548": { tecido: "JAC_TRIF_MESCLA", categoria: "JACQUARD" },
  "151501061":  { tecido: "PRESS", categoria: "NAO_COLOCAR" },

  "1515010744": { tecido: "CALIFORNIA", categoria: "PROMOCOES" },
  "1515011287": { tecido: "CANNES", categoria: "CAMISARIA" },
  "1515011360": { tecido: "CALIFORNIA_EMPIRE", categoria: "PROMOCOES" },
  "1515011363": { tecido: "CALIFORNIA_VENICE", categoria: "PROMOCOES" },

  "1515011398": { tecido: "HAVAI_UV", categoria: "LISOS" },
  "151501173":  { tecido: "ASTRO", categoria: "CAMISARIA" },
  "1515011984": { tecido: "FORRO", categoria: "LISOS" },

  "1515012035": { tecido: "PARIS", categoria: "BLACKOUT" },
  "1515012068": { tecido: "MOSCOU_PES_PT", categoria: "BLACKOUT" },

  "1515012094": { tecido: "JAC_FUSION_1153", categoria: "JACQUARD" },
  "1515012732": { tecido: "JACQUARD_FUSION_STJ105", categoria: "JACQUARD" },

  "1515013260": { tecido: "CALIFORNIA_ABC16", categoria: "PROMOCOES" },
  "1515013618": { tecido: "ACTIVE_POWER", categoria: "LISOS" },

  "1515013728": { tecido: "LUMINOUS_FIT", categoria: "BRILHOSOS" },
  "1515014195": { tecido: "VIVANCE_FIT", categoria: "BRILHOSOS" },
  "1515014235": { tecido: "LUMINOUS_BEACH", categoria: "BRILHOSOS" },
  "1515014243": { tecido: "ILUMINAT_FIT", categoria: "BRILHOSOS" },
  "1515014505": { tecido: "VIVANCE_BEACH", categoria: "BRILHOSOS" },

  "1515014508": { tecido: "JAC_TEX_CLEAN_TMJ557", categoria: "JACQUARD" },
  "1515014531": { tecido: "JAC_CLASSIC_BRILHO", categoria: "JACQUARD" },
  "1515014547": { tecido: "DIAMANTE", categoria: "BRILHOSOS" },
  "1515014580": { tecido: "DIAMANTE_BEACH", categoria: "BRILHOSOS" },

  "1515014609": { tecido: "JAC_LUX_STJ105", categoria: "JACQUARD" },
  "1515014703": { tecido: "DUETO", categoria: "BRILHOSOS" },

  "1515014764": { tecido: "DUPLEX_POWER", categoria: "LISOS" },
  "1515014767": { tecido: "JAC_LUX_ABJH13", categoria: "JACQUARD" },

  "1515014842": { tecido: "ILUMINAT_BEACH", categoria: "BRILHOSOS" },

  "1515015006": { tecido: "JAC_LUX_INVERT_ABJ536G2", categoria: "JACQUARD" },
  "1515015009": { tecido: "NEW_YORK", categoria: "BLACKOUT" },
  "1515015010": { tecido: "CRISTAL", categoria: "BRILHOSOS" },

  "1515015101": { tecido: "PARIS_LIGHT", categoria: "LISOS" },
  "1515015129": { tecido: "PRISMA", categoria: "LISOS" },

  "1515015151": { tecido: "JACQUARD_LUX_NS030", categoria: "JACQUARD" },

  "1515015223": { tecido: "MOVE", categoria: "CAMISARIA" },

  "1515015355": { tecido: "JAC_LUX_ABJL56B", categoria: "JACQUARD" },
  "1515015356": { tecido: "JAC_LUX_ABJL57", categoria: "JACQUARD" },

  "1515015552": { tecido: "NEW_YORK_LIGHT", categoria: "BLACKOUT" },

  "1515015614": { tecido: "BERLIM_MAQ_10", categoria: "BLACKOUT" },
  "1515015615": { tecido: "MOSCOU", categoria: "BLACKOUT" },
  "1515015617": { tecido: "BERLIM_OPACO_MAQ_10", categoria: "BLACKOUT" },

  "1515015767": { tecido: "CANNES_140", categoria: "CAMISARIA" },

  "151501814":  { tecido: "CROSS_UV", categoria: "LISOS" },
  "151501934":  { tecido: "JERSEY_POWER_CASPER", categoria: "JACQUARD" },
  "151502082":  { tecido: "BERLIM_LIGHT", categoria: "BLACKOUT" },

  "1515014850": { tecido: "CANNES_BRILHO", categoria: "CAMISARIA" },
  "151501984":  { tecido: "ENERGY", categoria: "CAMISARIA" },

  "1515014928": { tecido: "JERSEY_POWER_MICRON", categoria: "JACQUARD" },

  "1515014378": { tecido: "HAVAI_DIGITAL_UV_AVESSO_ST220", categoria: "PROMOCOES" },
  "1515013205": { tecido: "HAVAI_DIGITAL_UV_AB487", categoria: "PROMOCOES" },
  "1515014399": { tecido: "SILK_DIGITAL_UV_AB1907_V1", categoria: "PROMOCOES" },
  "1515014394": { tecido: "HAVAI_DIGITAL_UV_AVESSO_CD031_V2", categoria: "PROMOCOES" },

  "1515012690": { tecido: "CROSS_DIGITAL_UV_CL56_V1", categoria: "PROMOCOES" },
  "1515015494": { tecido: "CROSS_DIGITAL_UV_AB4149_V1", categoria: "PROMOCOES" },
  "1515015727": { tecido: "CROSS_DIGITAL_UV_AB4207_V3", categoria: "PROMOCOES" }
};

/* ================= REALTIME ================= */
onSnapshot(query(tecidosCol), snap => {
  tecidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
  atualizarFiltros();
});

/* ================= MODAL ================= */
window.abrirModal = (id, peso, nome) => {
  itemSelecionado = {
    id,
    pesoTexto: peso,
    pesoNumero: Number(String(peso).replace(",", ".")),
    nome
  };
  document.getElementById("modal-titulo").innerText = nome;
  document.getElementById("modal-peso").innerText = peso;
  document.getElementById("ajuste-modal").classList.add("active");
};

window.mudarValor = v => {
  itemSelecionado.pesoNumero = Math.max(0, itemSelecionado.pesoNumero + v);
  itemSelecionado.pesoTexto = itemSelecionado.pesoNumero.toString().replace(".", ",");
  document.getElementById("modal-peso").innerText = itemSelecionado.pesoTexto;
};

window.fecharModal = () =>
  document.getElementById("ajuste-modal").classList.remove("active");

window.salvarAjuste = async () => {
  if (prompt("Senha:") === SENHA_MESTRA) {
    await updateDoc(doc(db, "tecidos", itemSelecionado.id), {
      quantidadeKg: itemSelecionado.pesoTexto
    });
    fecharModal();
  }
};

/* ================= RENDER ================= */
function render() {
  const app = document.getElementById("app-content");
  app.innerHTML = "";

  const dados = filtroAtual === "todos"
    ? tecidos
    : tecidos.filter(t => t.categoria === filtroAtual);

  const subs = [...new Set(dados.map(t => t.sub))].sort();

  subs.forEach(sub => {
    const section = document.createElement("section");
    section.innerHTML = `<h2 class="text-[9px] text-slate-400 font-bold mb-1 ml-1">${sub}</h2>`;

    const grid = document.createElement("div");
    grid.className = "color-grid";

    dados.filter(t => t.sub === sub).forEach(t => {
      const kgNum = Number(String(t.quantidadeKg).replace(",", "."));
      const rolos = Math.floor(kgNum / KG_POR_ROLO);

      grid.innerHTML += `
      <div onclick="abrirModal('${t.id}','${t.quantidadeKg}','${t.cor}')"
        class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">

        <div class="relative aspect-square w-full">
          <img
            src="${getImagemPrincipal(t.sub, t.cor)}"
            data-img1="${getImagemPrincipal(t.sub, t.cor)}"
            data-img2="${getImagemSecundaria(t.sub, t.cor)}"
            data-state="1"
            class="w-full h-full object-cover"
            onerror="this.src='imagens/tecidos/sem-imagem.jpg'">
          <button
            onclick="alternarImagem(event, this)"
            class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-2 py-1 rounded">
            â†»
          </button>
        </div>

        <div class="p-1.5">
          <p class="text-[7px] text-slate-400 font-bold truncate">${t.cor}</p>
          <div class="flex justify-between items-center">
            <span class="text-[10px] text-blue-400 font-black">${rolos}R</span>
            <span class="text-[7px] text-slate-500 font-bold">${t.quantidadeKg}k</span>
          </div>
        </div>
      </div>`;
    });

    section.appendChild(grid);
    app.appendChild(section);
  });
}

/* ================= IMPORTAÃ‡ÃƒO EXCEL (RECONHECE TUDO) ================= */
document.getElementById("excel-input").addEventListener("change", e => {
    const reader = new FileReader();

    reader.onload = async evt => {
        const workbook = XLSX.read(evt.target.result, { type: "binary" });
        const rows = XLSX.utils.sheet_to_json(
            workbook.Sheets[workbook.SheetNames[0]],
            { defval: "" }
        );

        for (const r of rows) {

            // ðŸ”‘ CODIGO identifica TECIDO e CATEGORIA
            const codigo = String(r.CODIGO || "").trim();
            const produto = MAPA_PRODUTOS[codigo] || {
                tecido: "DESCONHECIDO",
                categoria: "SEM_CATEGORIA"
            };

            // ðŸŽ¨ HEX identifica cor visual
            const hexCodigo = String(r.HEX || "").match(/\d+/)?.toString() || "";

            // âš–ï¸ Quantidade
            const quantidade = String(r.QUANTIDADE || "0").trim();

            const dadosObj = {
                hex: hexCodigo,
                codigo: codigo,
                sub: produto.tecido,          // TECIDO
                categoria: produto.categoria, // CATEGORIA
                cor: String(r.COR || "").toUpperCase().trim(),
                quantidadeKg: quantidade
            };

            // evita duplicar pelo mesmo CODIGO + COR
            const existe = tecidos.find(
                t => t.codigo === codigo && t.cor === dadosObj.cor
            );

            if (existe) {
                await updateDoc(doc(db, "tecidos", existe.id), dadosObj);
            } else {
                await addDoc(tecidosCol, dadosObj);
            }
        }

        alert("ImportaÃ§Ã£o concluÃ­da com reconhecimento automÃ¡tico!");
    };

    reader.readAsBinaryString(e.target.files[0]);
});


/* ================= FILTROS ================= */
window.filtrar = c => {
  filtroAtual = c;
  render();
  atualizarFiltros();
};

function atualizarFiltros() {
  const el = document.getElementById("dynamic-filters");
  const cats = ["todos", ...new Set(tecidos.map(t => t.categoria))];
  el.innerHTML = cats.map(c =>
    `<button onclick="filtrar('${c}')"
      class="px-3 py-1 text-[8px] rounded-full font-bold
      ${filtroAtual === c ? "bg-blue-600" : "bg-slate-800"}">${c}</button>`
  ).join("");
}

/* ================= IMAGEM TOGGLE ================= */
window.alternarImagem = (e, btn) => {
  e.stopPropagation();
  const img = btn.previousElementSibling;
  if (img.dataset.state === "1") {
    img.src = img.dataset.img2;
    img.dataset.state = "2";
  } else {
    img.src = img.dataset.img1;
    img.dataset.state = "1";
  }
};

/* ================= LIMPAR ================= */
window.limparTudo = async () => {
  if (prompt("Digite a senha para ZERAR o estoque:") === SENHA_MESTRA) {
    const snap = await getDocs(tecidosCol);
    for (const d of snap.docs)
      await deleteDoc(doc(db, "tecidos", d.id));
    alert("Banco zerado.");
  }
};
</script>


</body>
</html>
