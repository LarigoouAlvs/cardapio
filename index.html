<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soutex - Central de Rolos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .filter-scroll { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans hide-scroll">

    <div id="ajuste-modal" class="modal p-4">
        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 id="modal-titulo" class="text-center font-black italic text-blue-500 uppercase mb-4 text-sm">Ajustar Estoque</h3>
            
            <div class="flex items-center justify-between gap-4 mb-6">
                <button onclick="mudarValor(-15)" class="bg-red-600 hover:bg-red-500 w-12 h-12 rounded-full font-black text-xl">-15</button>
                <div class="text-center">
                    <div id="modal-peso" class="text-3xl font-black">0.0</div>
                    <div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Quilos Totais</div>
                </div>
                <button onclick="mudarValor(15)" class="bg-green-600 hover:bg-green-500 w-12 h-12 rounded-full font-black text-xl">+15</button>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="fecharModal()" class="bg-slate-800 py-3 rounded-xl font-bold text-[10px] uppercase">Cancelar</button>
                <button onclick="salvarAjuste()" class="bg-blue-600 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-blue-900/40">Confirmar Senha</button>
            </div>
        </div>
    </div>

    <header class="p-4 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
        <div class="flex justify-between items-center mb-3">
            <div>
                <h1 class="text-sm font-black text-blue-500 italic">SOUTEX_PRO</h1>
                <p class="text-[8px] text-slate-500 uppercase font-bold tracking-[0.3em]">Clique no tecido para ajustar</p>
            </div>
            <div class="flex gap-2">
                <button onclick="limparTudo()" class="bg-red-500/10 text-red-500 text-[9px] px-2 py-2 rounded-md border border-red-500/20 font-bold uppercase tracking-tighter">Zerar Banco</button>
                <label class="bg-blue-600 text-white text-[9px] px-4 py-2 rounded-md cursor-pointer font-black italic">
                    IMPORTAR EXCEL
                    <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
        </div>
        <div id="dynamic-filters" class="flex gap-2 overflow-x-auto pb-1 hide-scroll"></div>
    </header>

    <main class="p-3 space-y-8" id="app-content"></main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJgHz4GGt1kPq3md5wcVdtYUlqij1i4PE",
            authDomain: "soutex-e9d93.firebaseapp.com",
            projectId: "soutex-e9d93",
            storageBucket: "soutex-e9d93.firebasestorage.app",
            messagingSenderId: "755619229918",
            appId: "1:755619229918:web:a686d19782dc759946124f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tecidosCol = collection(db, "tecidos");

        const SENHA_MESTRA = "1234";
        const KG_POR_ROLO = 15;

        // --- DICIONÁRIO COMPLETO (CARTELAS 24/25 E 25/26) ---
        const CONVERSOR_PANTONE = {
            // Básicos e Neutros [cite: 5, 6, 79, 80, 144, 74]
            "003": "#FFFFFF", "110105": "#F8F0E3", "50210": "#1A1A1A", "002": "#1A1A1A", "502477": "#404633", "150947": "#8B8680",
            // Amarelos e Laranjas [cite: 15, 18, 19, 81, 85, 86, 87, 92]
            "160928": "#C5A059", "120824": "#F6D7A7", "140957": "#F2D06B", "161054": "#FFD700", "130650": "#DFFF00", "131023": "#FFBE98", "161358": "#F96332", "161449": "#B35A42", "181561": "#E64E2E", "201353": "#A67B5B",
            // Rosas e Roxos [cite: 8, 23, 24, 26, 28, 30, 101, 107, 109, 111, 116, 40]
            "69572": "#FFB7D5", "121708": "#F1D2D8", "171937": "#FF3381", "153214": "#D975A5", "163118": "#BB548E", "A65": "#FC8EAC", "40549": "#FF1493", "30192": "#FF7F50", "171930": "#E45E8C", "172036": "#AD1C57", "181852": "#BD3D3E", "181663": "#BD3D3E", "191555": "#6D232F", "01218": "#4A101C", "192033": "#6B322E", "153716": "#B39FBD", "650200": "#632A7E", "183324": "#8B498B", "1546": "#6D3192", "192816": "#3D2431", "450924": "#E0B0FF",
            // Verdes [cite: 44, 45, 46, 124, 47, 48, 49, 50]
            "155218": "#98FF98", "146330": "#85C685", "175335": "#4AB081", "156428": "#B7D5AC", "170210": "#4A5D23", "160430": "#77B17E", "190323": "#4B5332", "195232": "#134237",
            // Azuis [cite: 51, 52, 53, 54, 55, 56, 132, 57, 58]
            "144318": "#99D3DF", "154225": "#7BA0BA", "164535": "#6BA6CC", "164411": "#82898F", "174028": "#527694", "901068": "#002366", "900783": "#003399", "194342": "#2C4053", "193933": "#232D4B",
            // Marrons e Cinzas [cite: 59, 60, 61, 62, 63, 138, 65, 68, 69, 72, 73, 143]
            "190814": "#3A2A21", "191432": "#4E3E38", "191220": "#6D5344", "181222": "#5E4334", "171230": "#8D6E5D", "181425": "#4B2C20", "161318": "#A47754", "144203": "#B8B8B8", "173802": "#959595", "550888": "#6B7177", "550834": "#4A4E52", "193906": "#353839"
        };

        let tecidos = [];
        let filtroAtual = 'todos';
        let itemSelecionado = null;

        onSnapshot(query(tecidosCol), (snapshot) => {
            tecidos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
            atualizarFiltros();
        });

        // LOGICA DO MODAL
        window.abrirModal = (id, peso, nome) => {
            itemSelecionado = { id, pesoOriginal: peso, pesoAjustado: peso, nome };
            document.getElementById('modal-titulo').innerText = nome;
            document.getElementById('modal-peso').innerText = peso.toFixed(1);
            document.getElementById('ajuste-modal').classList.add('active');
        };

        window.mudarValor = (valor) => {
            if(!itemSelecionado) return;
            itemSelecionado.pesoAjustado = Math.max(0, itemSelecionado.pesoAjustado + valor);
            document.getElementById('modal-peso').innerText = itemSelecionado.pesoAjustado.toFixed(1);
        };

        window.fecharModal = () => {
            document.getElementById('ajuste-modal').classList.remove('active');
            itemSelecionado = null;
        };

        window.salvarAjuste = async () => {
            const pw = prompt("Digite a senha para confirmar alteração:");
            if (pw === SENHA_MESTRA) {
                await updateDoc(doc(db, "tecidos", itemSelecionado.id), { 
                    quantidadeKg: itemSelecionado.pesoAjustado 
                });
                fecharModal();
            } else if (pw !== null) alert("Senha incorreta!");
        };

        window.render = function() {
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            const dados = filtroAtual === 'todos' ? tecidos : tecidos.filter(t => t.categoria === filtroAtual);
            const subs = [...new Set(dados.map(t => t.sub))].sort();

            subs.forEach(sub => {
                const section = document.createElement('section');
                section.innerHTML = `<h2 class="text-[10px] font-black text-slate-600 uppercase mb-4 border-l-2 border-blue-600 pl-3 tracking-widest">${sub}</h2>`;
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3";
                
                dados.filter(t => t.sub === sub).forEach(t => {
                    const codLimpo = String(t.hex).replace(/\D/g, '').trim();
                    const corHex = CONVERSOR_PANTONE[codLimpo] || "#334155";
                    const rolos = Math.floor(t.quantidadeKg / KG_POR_ROLO);
                    
                    grid.innerHTML += `
                        <div onclick="abrirModal('${t.id}', ${t.quantidadeKg}, '${t.cor}')" class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden cursor-pointer active:scale-95 transition-all">
                            <div class="aspect-square" style="background-color: ${corHex}"></div>
                            <div class="p-2">
                                <p class="text-[8px] font-bold truncate">${t.cor}</p>
                                <div class="flex justify-between items-end mt-1">
                                    <span class="text-blue-400 font-black text-sm">${rolos}R</span>
                                    <span class="text-[7px] text-slate-500 font-bold">${t.quantidadeKg.toFixed(1)}kg</span>
                                </div>
                            </div>
                        </div>`;
                });
                container.appendChild(section);
                section.appendChild(grid);
            });
        };

        document.getElementById('excel-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                for (const row of json) {
                    const hexOriginal = String(row.Hex || '').trim();
                    const codPantone = hexOriginal.match(/\d+/) ? hexOriginal.match(/\d+/)[0] : hexOriginal;
                    const pesoKg = parseFloat(String(row.Quantidade || 0).replace(',', '.'));

                    const dadosObj = {
                        categoria: String(row.Categoria || 'GERAL').toUpperCase().trim(),
                        sub: String(row.Subcategoria || 'GERAL').toUpperCase().trim(),
                        cor: String(row.Cor || 'SEM NOME').toUpperCase().trim(),
                        hex: codPantone,
                        quantidadeKg: pesoKg
                    };

                    const existente = tecidos.find(t => t.cor === dadosObj.cor && t.sub === dadosObj.sub);
                    if (existente) await updateDoc(doc(db, "tecidos", existente.id), dadosObj);
                    else await addDoc(tecidosCol, dadosObj);
                }
                alert("Estoque Atualizado!");
            };
            reader.readAsBinaryString(file);
        });

        window.filtrar = (cat) => { filtroAtual = cat; render(); atualizarFiltros(); };
        function atualizarFiltros() {
            const container = document.getElementById('dynamic-filters');
            const cats = ['todos', ...new Set(tecidos.map(t => t.categoria))];
            container.innerHTML = cats.map(c => `
                <button onclick="filtrar('${c}')" class="${filtroAtual === c ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-500'} text-[9px] px-4 py-1.5 rounded-full font-bold uppercase transition-all whitespace-nowrap">
                    ${c}
                </button>
            `).join('');
        }

        window.limparTudo = async () => {
            if (prompt("Senha para ZERAR TUDO:") === SENHA_MESTRA) {
                const snap = await getDocs(tecidosCol);
                for (const d of snap.docs) await deleteDoc(doc(db, "tecidos", d.id));
            }
        };
    </script>
</body>
</html>
