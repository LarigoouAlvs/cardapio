<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soutex - Grid 16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Ajuste para garantir que os cards caibam 4 por linha em telas pequenas */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px;
        }
        .filter-scroll { overflow-x: auto; white-space: nowrap; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(6px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-black text-slate-100 font-sans hide-scroll">

    <div id="ajuste-modal" class="modal p-4">
        <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl w-full max-w-xs shadow-2xl">
            <h3 id="modal-titulo" class="text-center font-black text-blue-500 uppercase mb-4 text-xs tracking-widest">Tecido</h3>
            
            <div class="flex items-center justify-between gap-3 mb-6">
                <button onclick="mudarValor(-15)" class="bg-red-600 active:bg-red-700 w-12 h-12 rounded-full font-black text-lg shadow-lg">-15</button>
                <div class="text-center">
                    <div id="modal-peso" class="text-3xl font-black text-white">0.0</div>
                    <div class="text-[9px] text-slate-500 uppercase font-bold">Quilos (Kg)</div>
                </div>
                <button onclick="mudarValor(15)" class="bg-green-600 active:bg-green-700 w-12 h-12 rounded-full font-black text-lg shadow-lg">+15</button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="fecharModal()" class="bg-slate-800 p-3 rounded-xl font-bold text-[9px] uppercase">Sair</button>
                <button onclick="salvarAjuste()" class="bg-blue-600 p-3 rounded-xl font-black text-[9px] uppercase shadow-blue-900/40 shadow-md">Salvar</button>
            </div>
        </div>
    </div>

    <header class="p-3 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-[11px] font-black text-blue-500 italic">SOUTEX_16GRID</h1>
            <div class="flex gap-1">
                <button onclick="limparTudo()" class="text-[8px] border border-red-500/30 text-red-500 px-2 py-1 rounded">ZERAR</button>
                <label class="bg-blue-600 text-[8px] px-3 py-1.5 rounded font-black cursor-pointer">
                    EXCEL <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
        </div>
        <div id="dynamic-filters" class="flex gap-2 overflow-x-auto pb-1 hide-scroll"></div>
    </header>

    <main class="p-2" id="app-content"></main>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
    apiKey: "AIzaSyBJgHz4GGt1kPq3md5wcVdtYUlqij1i4PE",
    authDomain: "soutex-e9d93.firebaseapp.com",
    projectId: "soutex-e9d93",
    storageBucket: "soutex-e9d93.firebasestorage.app",
    messagingSenderId: "755619229918",
    appId: "1:755619229918:web:a686d19782dc759946124f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const tecidosCol = collection(db, "tecidos");

/* ================= CONFIG ================= */
const SENHA_MESTRA = "1234";
const KG_POR_ROLO = 15;

let tecidos = [];
let filtroAtual = "todos";
let itemSelecionado = null;

/* ================= IMAGENS ================= */
function normalizarTexto(txt) {
    return String(txt)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "_")
        .toUpperCase()
        .trim();
}

function getImagemProduto(sub, cor) {
    return `imagens/tecidos/${normalizarTexto(sub)}_${normalizarTexto(cor)}.jpg`;
}

                // --- DICIONÁRIO COMPLETO (CARTELAS 24/25 E 25/26) ---
        const CONVERSOR_PANTONE = {
            // Básicos e Neutros [cite: 5, 6, 79, 80, 144, 74]
            "003": "#FFFFFF", "110105": "#F8F0E3", "50210": "#1A1A1A", "002": "#1A1A1A", "502477": "#404633", "150947": "#8B8680",
            // Amarelos e Laranjas [cite: 15, 18, 19, 81, 85, 86, 87, 92]
            "160928": "#C5A059", "120824": "#F6D7A7", "140957": "#F2D06B", "161054": "#FFD700", "130650": "#DFFF00", "131023": "#FFBE98", "161358": "#F96332", "161449": "#B35A42", "181561": "#E64E2E", "201353": "#A67B5B",
            // Rosas e Roxos [cite: 8, 23, 24, 26, 28, 30, 101, 107, 109, 111, 116, 40]
            "69572": "#FFB7D5", "121708": "#F1D2D8", "171937": "#FF3381", "153214": "#D975A5", "163118": "#BB548E", "A65": "#FC8EAC", "40549": "#FF1493", "30192": "#FF7F50", "171930": "#E45E8C", "172036": "#AD1C57", "181852": "#BD3D3E", "181663": "#BD3D3E", "191555": "#6D232F", "01218": "#4A101C", "192033": "#6B322E", "153716": "#B39FBD", "650200": "#632A7E", "183324": "#8B498B", "1546": "#6D3192", "192816": "#3D2431", "450924": "#E0B0FF",
            // Verdes [cite: 44, 45, 46, 124, 47, 48, 49, 50]
            "155218": "#98FF98", "146330": "#85C685", "175335": "#4AB081", "156428": "#B7D5AC", "170210": "#4A5D23", "160430": "#77B17E", "190323": "#4B5332", "195232": "#134237",
            // Azuis [cite: 51, 52, 53, 54, 55, 56, 132, 57, 58]
            "144318": "#99D3DF", "154225": "#7BA0BA", "164535": "#6BA6CC", "164411": "#82898F", "174028": "#527694", "901068": "#002366", "900783": "#003399", "194342": "#2C4053", "193933": "#232D4B",
            // Marrons e Cinzas [cite: 59, 60, 61, 62, 63, 138, 65, 68, 69, 72, 73, 143]
            "190814": "#3A2A21", "191432": "#4E3E38", "191220": "#6D5344", "181222": "#5E4334", "171230": "#8D6E5D", "181425": "#4B2C20", "161318": "#A47754", "144203": "#B8B8B8", "173802": "#959595", "550888": "#6B7177", "550834": "#4A4E52", "193906": "#353839"
        };

/* ================= FIREBASE REALTIME ================= */
onSnapshot(query(tecidosCol), snap => {
    tecidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
    atualizarFiltros();
});

/* ================= MODAL ================= */
window.abrirModal = (id, pesoTexto, nome) => {
    itemSelecionado = {
        id,
        pesoTexto,
        pesoNumero: Number(String(pesoTexto).replace(",", ".")),
        nome
    };
    document.getElementById("modal-titulo").innerText = nome;
    document.getElementById("modal-peso").innerText = itemSelecionado.pesoTexto;
    document.getElementById("ajuste-modal").classList.add("active");
};

window.mudarValor = v => {
    itemSelecionado.pesoNumero = Math.max(0, itemSelecionado.pesoNumero + v);
    itemSelecionado.pesoTexto = itemSelecionado.pesoNumero.toString().replace(".", ",");
    document.getElementById("modal-peso").innerText = itemSelecionado.pesoTexto;
};

window.fecharModal = () =>
    document.getElementById("ajuste-modal").classList.remove("active");

window.salvarAjuste = async () => {
    if (prompt("Senha:") === SENHA_MESTRA) {
        await updateDoc(doc(db, "tecidos", itemSelecionado.id), {
            quantidadeKg: itemSelecionado.pesoTexto
        });
        fecharModal();
    }
};

/* ================= RENDER ================= */
window.render = function () {
    const app = document.getElementById("app-content");
    app.innerHTML = "";

    const dados = filtroAtual === "todos" ? tecidos : tecidos.filter(t => t.categoria === filtroAtual);
    const subs = [...new Set(dados.map(t => t.sub))].sort();

    subs.forEach(sub => {
        const section = document.createElement("section");
        section.innerHTML = `<h2 class="text-[9px] text-slate-400 font-bold mb-1 ml-1">${sub}</h2>`;

        const grid = document.createElement("div");
        grid.className = "color-grid";

        dados.filter(t => t.sub === sub).forEach(t => {
            const img = getImagemProduto(t.sub, t.cor);
            const hex = CONVERSOR_PANTONE[String(t.hex).replace(/\D/g, "")] || "#1f2937";
            const kgNum = Number(String(t.quantidadeKg).replace(",", "."));
            const rolos = Math.floor(kgNum / KG_POR_ROLO);

            grid.innerHTML += `
            <div onclick="abrirModal('${t.id}','${t.quantidadeKg}','${t.cor}')"
                 class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
                 
                <div class="aspect-square w-full">
    <img 
        src="${img}" 
        alt="${t.cor}"
        class="w-full h-full object-cover"
        onerror="this.src='imagens/tecidos/sem-imagem.jpg'">
</div>


                <div class="p-1.5">
                    <p class="text-[7px] text-slate-400 font-bold truncate">${t.cor}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] text-blue-400 font-black">${rolos}R</span>
                        <span class="text-[7px] text-slate-500 font-bold">${t.quantidadeKg}k</span>
                    </div>
                </div>
            </div>`;
        });

        section.appendChild(grid);
        app.appendChild(section);
    });
};

/* ================= IMPORTAÇÃO EXCEL ================= */
document.getElementById("excel-input").addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = async evt => {
        const workbook = XLSX.read(evt.target.result, { type: "binary" });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });

        for (const r of rows) {
            const dadosObj = {
                categoria: String(r.Categoria).toUpperCase().trim(),
                sub: String(r.Subcategoria).toUpperCase().trim(),
                cor: String(r.Cor).toUpperCase().trim(),
                hex: String(r.Hex || "").match(/\d+/)?.toString() || "",
                quantidadeKg: String(r.Quantidade).trim()
            };

            const existe = tecidos.find(t => t.cor === dadosObj.cor && t.sub === dadosObj.sub);
            if (existe) await updateDoc(doc(db, "tecidos", existe.id), dadosObj);
            else await addDoc(tecidosCol, dadosObj);
        }
        alert("Importado com sucesso!");
    };
    reader.readAsBinaryString(e.target.files[0]);
});

/* ================= FILTROS ================= */
window.filtrar = c => {
    filtroAtual = c;
    render();
    atualizarFiltros();
};

function atualizarFiltros() {
    const el = document.getElementById("dynamic-filters");
    const cats = ["todos", ...new Set(tecidos.map(t => t.categoria))];
    el.innerHTML = cats.map(c =>
        `<button onclick="filtrar('${c}')" class="px-3 py-1 text-[8px] rounded-full font-bold ${filtroAtual === c ? "bg-blue-600" : "bg-slate-800"}">${c}</button>`
    ).join("");
}

/* ================= LIMPAR ================= */
window.limparTudo = async () => {
    if (prompt("Senha:") === SENHA_MESTRA) {
        const snap = await getDocs(tecidosCol);
        for (const d of snap.docs) await deleteDoc(doc(db, "tecidos", d.id));
    }
};
</script>

</body>
</html>
